# Berklee 7-Position Guitar Visualization — Claude Code 引き継ぎレポート

## プロジェクト概要

Berklee音楽院の7ポジションシステムに基づくギター指板ビジュアライザー。
現在はReact JSX (Claude.ai Artifact) として動作。Webアプリ化を予定。

---

## 現在の機能

- 7モード (Ionian〜Locrian) の切替表示（ルート: C 固定）
- 7ポジションの個別表示 / 全表示 / オーバーレイ表示
- コードトーン強調 (Cmaj7 / C7 / Cm7 / Cm7♭5)
- ラベル切替（音名 / 度数）
- SVG指板描画 (21フレット)
- ポジション詳細パネル（弦ごとのフレット・音名表示）

---

## コアアルゴリズム解説

### ポジション生成の仕組み

Berklee 7ポジションシステムの核心は **B弦（2弦）が各ポジションで2音のみ** という点。
他の弦はすべて3音。これはB-G弦間の長3度チューニングに起因する。

#### ステップ1: フレットマップ生成 (`buildFretMap`)
```
入力: スケールの半音配列 + 音名配列
出力: 弦ごとの [音名, フレット番号, 半音値] の配列
```
- 6弦すべてについて、フレット1〜21のどこにスケール音があるかをマッピング
- 開放弦チューニング: `[4, 11, 7, 2, 9, 4]` = E B G D A E (半音値)

#### ステップ2: ポジション生成 (`generatePositions`)

**B弦ペア生成:**
1. B弦上の全スケール音から、隣接する2音ペア（スケール度数が連続）を抽出
2. `allPairs[0]` はルート音から始まるペア（C Ionian なら C,D）
3. `allPairs.slice(1, 8)` で2度から始まる7ペアを取得 → これが Pos 1〜7

**トリオ生成と割り当て:**
1. 各弦（1E, G, D, A）で連続3音のトリオを昇順に列挙
2. **B弦ペアとトリオを1:1で順次割り当て**（最低フレットから順番）

### ⚠️ 重要: アルゴリズムの経緯と落とし穴

開発中に以下のアプローチで失敗した。今後の修正時に同じ轍を踏まないこと。

| 試行 | 方法 | 結果 | 失敗理由 |
|------|------|------|----------|
| ❌ 1 | Greedy matcher (B弦center距離で最近トリオ割当) | Pos1の1E弦がG,A,Bに | ルートペアC,DがF,G,Aトリオを先取り |
| ❌ 2 | B弦ペアを生成後にローテート | 13シェイプ | トリオ割当がペア順序に依存 |
| ❌ 3 | 生成offset変更 (2度から開始) | 12シェイプ | 開始フレットが変わりトリオ選択が変化 |
| ❌ 4 | displayIdだけ振替 | B弦と他弦が1ポジションずれる | インデックスは変えずidだけ変えたため |
| ❌ 5 | positions配列全体をローテート | Pos7のB弦fret1に他弦fret12-16 | ペアとトリオの物理的位置が不整合 |
| ❌ 6 | 8ペア生成→index0を消費→index1-7採用 | 1E弦がまだG,A,B | greedy matcherの根本問題は同じ |
| ✅ 7 | **1:1順次割当** | 7シェイプ、全ポジション正確 | シンプルが最強 |

**現在の正解アプローチ:**
- B弦: ルートペアをスキップ、2度ペアから7つ取得
- 他弦: 最低フレットからトリオを昇順列挙
- 割当: `trio[i]` → `pair[i]` の単純な1:1マッピング
- **greedy matcherは使わない**

### シェイプの不変性

7つのユニークなシェイプ（フレット間隔パターン）は全モード共通。
モードが変わると音名とフレット位置は変わるが、形状は同じ7種が現れる。
これはメジャースケールの7つのローテーションがそれぞれ異なる間隔パターンを持つため。

検証済み: 全7モード × 7ポジション = 49個中、ユニークシェイプは常に7。

---

## ファイル構成

```
berklee-positions-v2.jsx   ← 現在の動作するJSXファイル（Artifact用）
HANDOFF.md                 ← このレポート
```

---

## データ構造

### MODES 配列
```js
{
  key: "ionian",           // 識別子
  name: "Ionian",          // 表示名
  semi: [0,2,4,5,7,9,11],  // ルートからの半音間隔
  notes: ["C","D","E","F","G","A","B"],  // 音名
  degrees: { C:"1", D:"2", ... },        // 度数マップ
  chord: "Cmaj7",          // ダイアトニックコード
  chordTones: ["C","E","G","B"],         // コードトーン
  chordSub: "1 3 5 7"      // コードトーンの度数
}
```

### Position オブジェクト
```js
{
  id: 1,                    // ポジション番号 (1-7)
  bPair: "D, E",           // B弦の2音
  range: "1–5",            // フレット範囲
  strings: [               // 6弦分の配列 [1E, B, G, D, A, 6E]
    [[音名, フレット, 半音値], ...],  // 1E: 3音
    [[音名, フレット, 半音値], ...],  // B: 2音
    ...                               // G,D,A: 各3音
    // 6E = 1E と同一（同チューニング）
  ]
}
```

---

## 今後の開発予定

### 優先度高
1. **C以外のルート対応**
   - MODES配列の `semi` はルートからの相対間隔なので、ルート音の半音値をオフセットするだけ
   - 音名生成にはエンハーモニック（異名同音）の処理が必要
   - 例: F# Dorian の3度は A（A♭ではない）
   - シャープ系/フラット系の判定ロジックが必要

2. **コード進行連動表示**
   - コード進行入力 → 各コードに対応するモード/ポジションを自動選択
   - BPM/タイミング制御で自動切替
   - 例: `| Dm7 | G7 | Cmaj7 | Am7 |` → D Dorian Pos X → G Mixolydian Pos Y → ...

### 優先度中
3. コード進行のプリセット（II-V-I、Blues、Rhythm Changes 等）
4. ポジション間の移動ガイド（共通音のハイライト）
5. 音声再生（Web Audio API）

### 優先度低
6. カスタムスケール対応（メロディックマイナー、ハーモニックマイナー等）
7. 左利きモード
8. タブレット/モバイル最適化

---

## 技術的な注意事項

### ルート変更時のエンハーモニック処理
最大の技術的課題。以下のルールに従う必要がある:
- メジャースケールの音名はアルファベット A〜G が各1回ずつ登場（7音 = 7文字）
- シャープ/フラット付きの音名は、スケール度数に基づいて決定
- 例: D♭ Ionian = D♭ E♭ F G♭ A♭ B♭ C（G♭であってF#ではない）
- ダブルシャープ/ダブルフラットが必要なキーもある（理論上）

### B弦2音ルールの普遍性
このルールはギターの標準チューニング (EADGBE) に固有。
B-G弦間だけが長3度（他は完全4度）のため、7音スケールでは:
- B弦: 必ず2音
- 他弦: 必ず3音
これはスケールやモードに関わらず成立する。

### SVG描画のパフォーマンス
現在のSVG描画は21フレット×6弦の静的レンダリング。
コード進行連動で高速切替する場合、`useMemo` の依存配列を適切に設定し、
不要な再計算を避けること。現在のコードでは `fretMap` と `allPos` を
`modeIdx` に基づいてメモ化済み。

---

## 検証用コマンド

C Ionian Pos 1 の正解:
```
1E: F(1), G(3), A(5)
B:  D(3), E(5)
G:  A(2), B(4), C(5)
D:  E(2), F(3), G(5)
A:  B(2), C(3), D(5)
6E: F(1), G(3), A(5)
```

全モードで7ユニークシェイプが生成されることを必ず検証すること。
